<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSC Purchase Planning Demo</title>

    <!-- Omniapp Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mulish:ital,wght@0,200..1000;1,200..1000&family=Quattrocento:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bg-100': 'hsl(48 33.3% 97.1%)',
                        'bg-200': 'hsl(53 28.6% 94.5%)',
                        'bg-300': 'hsl(48 25% 92.2%)',
                        'bg-400': 'hsl(50 20.7% 88.6%)',
                        'bg-500': 'hsl(50 16.7% 84%)',
                        'text-100': 'hsl(60 2.6% 7.6%)',
                        'text-200': 'hsl(60 2.5% 23.3%)',
                        'text-300': 'hsl(60 2.5% 23.3%)',
                        'text-400': 'hsl(51 31.1% 43.7%)',
                        'accent-100': 'hsl(15 55.6% 52.4%)',
                        'accent-200': 'hsl(15 63.1% 59.6%)',
                        'danger-100': 'hsl(0 58.6% 34.1%)',
                        'danger-200': 'hsl(0 75% 75%)',
                        'border-100': 'hsl(30 3.3% 11.8% / 15%)',
                        'chart-1': 'oklch(0.646 0.222 41.116)',
                        'chart-2': 'oklch(0.6 0.118 184.704)',
                        'chart-3': 'oklch(0.398 0.07 227.392)',
                        'chart-4': 'oklch(0.828 0.189 84.429)',
                        'chart-5': 'oklch(0.769 0.188 70.08)',
                    },
                    fontFamily: {
                        sans: ['Mulish', 'Helvetica', 'sans-serif'],
                        serif: ['Quattrocento', 'serif'],
                    },
                    borderRadius: {
                        'lg': '0.625rem',
                    }
                }
            }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        body {
            font-family: 'Mulish', Helvetica, sans-serif;
            font-size: 15px;
        }
    </style>
</head>
<body class="bg-bg-100">
    <div id="root"></div>

    <script>
        const { useState, useEffect, useRef, createElement: h } = React;
        const { createRoot } = ReactDOM;

        // Mock Data
        const mockData = {
            purchaseSchedule: [
                { week: 1, currentQty: 85000, recommendedQty: 85000 },
                { week: 2, currentQty: 60000, recommendedQty: 60000 },
                { week: 3, currentQty: 95000, recommendedQty: 95000 },
                { week: 4, currentQty: 75000, recommendedQty: 75000 },
                { week: 5, currentQty: 140000, recommendedQty: 140000 },
                { week: 6, currentQty: 70000, recommendedQty: 70000 },
                { week: 7, currentQty: 85000, recommendedQty: 85000 },
                { week: 8, currentQty: 90000, recommendedQty: 90000 },
                { week: 9, currentQty: 65000, recommendedQty: 65000 },
                { week: 10, currentQty: 80000, recommendedQty: 80000 },
                { week: 11, currentQty: 95000, recommendedQty: 95000 },
                { week: 12, currentQty: 75000, recommendedQty: 75000 }
            ],
            inventoryProjection: [
                { week: 1, p10: 110000, p50: 120000, p90: 130000 },
                { week: 2, p10: 100000, p50: 115000, p90: 125000 },
                { week: 3, p10: 130000, p50: 145000, p90: 160000 },
                { week: 4, p10: 115000, p50: 130000, p90: 145000 },
                { week: 5, p10: 135000, p50: 155000, p90: 175000 },
                { week: 6, p10: 120000, p50: 140000, p90: 160000 },
                { week: 7, p10: 135000, p50: 160000, p90: 185000 },
                { week: 8, p10: 115000, p50: 135000, p90: 155000 },
                { week: 9, p10: 125000, p50: 150000, p90: 175000 },
                { week: 10, p10: 140000, p50: 165000, p90: 190000 },
                { week: 11, p10: 160000, p50: 190000, p90: 220000 },
                { week: 12, p10: 145000, p50: 175000, p90: 205000 }
            ],
            arrivals: [
                { week: 1, totalQty: 0 },
                { week: 2, totalQty: 0 },
                { week: 3, totalQty: 85000 },
                { week: 4, totalQty: 60000 },
                { week: 5, totalQty: 95000 },
                { week: 6, totalQty: 75000 },
                { week: 7, totalQty: 140000 },
                { week: 8, totalQty: 70000 },
                { week: 9, totalQty: 85000 },
                { week: 10, totalQty: 90000 },
                { week: 11, totalQty: 65000 },
                { week: 12, totalQty: 80000 }
            ],
            consumption: [
                { week: 1, total: 65000, confirmed: 50000, expected: 15000 },
                { week: 2, total: 70000, confirmed: 55000, expected: 15000 },
                { week: 3, total: 85000, confirmed: 65000, expected: 20000 },
                { week: 4, total: 100000, confirmed: 80000, expected: 20000 },
                { week: 5, total: 115000, confirmed: 90000, expected: 25000 },
                { week: 6, total: 72000, confirmed: 58000, expected: 14000 },
                { week: 7, total: 88000, confirmed: 70000, expected: 18000 },
                { week: 8, total: 95000, confirmed: 75000, expected: 20000 },
                { week: 9, total: 68000, confirmed: 52000, expected: 16000 },
                { week: 10, total: 82000, confirmed: 65000, expected: 17000 },
                { week: 11, total: 98000, confirmed: 78000, expected: 20000 },
                { week: 12, total: 76000, confirmed: 60000, expected: 16000 }
            ]
        };

        const rollstockWidthCombinations = [
            { rollstock: 'M23', widths: [70.25, 72.5, 80.0] },
            { rollstock: 'M24', widths: [70.25, 75.0] },
            { rollstock: 'M25', widths: [80.0, 85.5] }
        ];

        // Chart Component
        function ChartComponent({ type, data, options, height = 300 }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            ...options
                        }
                    });
                }
                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [type, data, options]);

            return h('div', { style: { height: `${height}px`, position: 'relative' } },
                h('canvas', { ref: canvasRef })
            );
        }

        // Main App
        function App() {
            const [selectedRollstock, setSelectedRollstock] = useState('M23');
            const [selectedWidth, setSelectedWidth] = useState(70.25);
            const [purchaseData, setPurchaseData] = useState([...mockData.purchaseSchedule]);
            const [showDecomposed, setShowDecomposed] = useState(false);

            const availableWidths = rollstockWidthCombinations.find(r => r.rollstock === selectedRollstock)?.widths || [];

            const handleRollstockChange = (e) => {
                const newRollstock = e.target.value;
                setSelectedRollstock(newRollstock);
                const widths = rollstockWidthCombinations.find(r => r.rollstock === newRollstock)?.widths || [];
                if (widths.length > 0 && !widths.includes(selectedWidth)) {
                    setSelectedWidth(widths[0]);
                }
            };

            const handleResetToRecommended = () => {
                setPurchaseData(mockData.purchaseSchedule.map(item => ({
                    ...item,
                    currentQty: item.recommendedQty
                })));
            };

            const handleDoNothing = () => {
                setPurchaseData(purchaseData.map(item => ({
                    ...item,
                    currentQty: 0
                })));
            };

            const handleSave = () => {
                alert('Purchase schedule saved!');
            };

            const handleQuantityChange = (week, newQty) => {
                setPurchaseData(purchaseData.map(item =>
                    item.week === week ? { ...item, currentQty: Math.round(newQty / 1000) * 1000 } : item
                ));
            };

            // Chart configurations
            const purchaseChartData = {
                labels: purchaseData.map(d => `Week ${d.week}`),
                datasets: [
                    {
                        label: 'Current Purchase Plan',
                        data: purchaseData.map(d => d.currentQty),
                        backgroundColor: 'oklch(0.646 0.222 41.116 / 0.85)',
                        borderColor: 'oklch(0.646 0.222 41.116)',
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: 'AI Recommendation',
                        data: purchaseData.map(d => d.recommendedQty),
                        type: 'line',
                        borderColor: 'hsl(0 58.6% 34.1%)',
                        borderWidth: 3,
                        pointRadius: 0,
                        fill: false
                    }
                ]
            };

            const inventoryChartData = {
                labels: mockData.inventoryProjection.map(d => `Week ${d.week}`),
                datasets: [
                    {
                        label: '90th Percentile',
                        data: mockData.inventoryProjection.map(d => d.p90),
                        borderColor: 'hsl(50 20.7% 88.6% / 0.8)',
                        backgroundColor: 'hsl(50 20.7% 88.6% / 0.3)',
                        fill: '+1',
                        pointRadius: 0,
                        borderWidth: 1
                    },
                    {
                        label: '50th Percentile',
                        data: mockData.inventoryProjection.map(d => d.p50),
                        borderColor: 'oklch(0.6 0.118 184.704)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: 'oklch(0.6 0.118 184.704)',
                        fill: false
                    },
                    {
                        label: '10th Percentile',
                        data: mockData.inventoryProjection.map(d => d.p10),
                        borderColor: 'hsl(50 20.7% 88.6% / 0.8)',
                        backgroundColor: 'transparent',
                        fill: false,
                        pointRadius: 0,
                        borderWidth: 1
                    }
                ]
            };

            const arrivalsChartData = {
                labels: mockData.arrivals.map(d => `Week ${d.week}`),
                datasets: [
                    {
                        label: 'Incoming Shipments',
                        data: mockData.arrivals.map(d => d.totalQty),
                        backgroundColor: 'oklch(0.828 0.189 84.429 / 0.85)',
                        borderColor: 'oklch(0.828 0.189 84.429)',
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            };

            const consumptionChartData = showDecomposed ? {
                labels: mockData.consumption.map(d => `Week ${d.week}`),
                datasets: [
                    {
                        label: 'Confirmed',
                        data: mockData.consumption.map(d => d.confirmed),
                        backgroundColor: 'oklch(0.398 0.07 227.392 / 0.9)',
                        borderColor: 'oklch(0.398 0.07 227.392)',
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: 'Expected',
                        data: mockData.consumption.map(d => d.expected),
                        backgroundColor: 'oklch(0.6 0.118 184.704 / 0.6)',
                        borderColor: 'oklch(0.6 0.118 184.704)',
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            } : {
                labels: mockData.consumption.map(d => `Week ${d.week}`),
                datasets: [
                    {
                        label: 'Total Consumption',
                        data: mockData.consumption.map(d => d.total),
                        backgroundColor: 'oklch(0.6 0.118 184.704 / 0.85)',
                        borderColor: 'oklch(0.6 0.118 184.704)',
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            };

            return h('div', { className: 'min-h-screen bg-bg-100 p-8' },
                h('div', { className: 'max-w-7xl mx-auto' },
                    h('h1', { className: 'text-3xl font-bold text-text-100 mb-8' }, 'PSC Purchase Planning'),

                    // Rollstock Selector
                    h('div', { className: 'bg-white rounded-lg shadow p-6 mb-6' },
                        h('div', { className: 'flex gap-4' },
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-text-200 mb-2' }, 'Rollstock'),
                                h('select', {
                                    value: selectedRollstock,
                                    onChange: handleRollstockChange,
                                    className: 'border border-border-100 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
                                }, rollstockWidthCombinations.map(r =>
                                    h('option', { key: r.rollstock, value: r.rollstock }, r.rollstock)
                                ))
                            ),
                            h('div', null,
                                h('label', { className: 'block text-sm font-medium text-text-200 mb-2' }, 'Width'),
                                h('select', {
                                    value: selectedWidth,
                                    onChange: (e) => setSelectedWidth(parseFloat(e.target.value)),
                                    className: 'border border-border-100 rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500'
                                }, availableWidths.map(w =>
                                    h('option', { key: w, value: w }, w)
                                ))
                            )
                        )
                    ),

                    // Panel 1: Purchase Recommendations
                    h('div', { className: 'bg-white rounded-lg shadow p-6 mb-6' },
                        h('div', { className: 'flex justify-between items-center mb-4' },
                            h('h2', { className: 'text-xl font-semibold text-text-100' }, 'Recommended Purchase Schedule'),
                            h('div', { className: 'flex gap-2' },
                                h('button', {
                                    onClick: handleDoNothing,
                                    className: 'px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition text-sm'
                                }, 'Do Nothing'),
                                h('button', {
                                    onClick: handleResetToRecommended,
                                    className: 'px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition text-sm'
                                }, 'Reset to Recommended'),
                                h('button', {
                                    onClick: handleSave,
                                    className: 'px-4 py-2 bg-accent-100 text-white rounded-md hover:bg-accent-200 transition text-sm'
                                }, 'Save')
                            )
                        ),
                        h(ChartComponent, {
                            type: 'bar',
                            data: purchaseChartData,
                            options: {
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: (items) => items[0].label,
                                            label: (context) => {
                                                const dataIndex = context.dataIndex;
                                                const current = purchaseData[dataIndex].currentQty;
                                                const recommended = purchaseData[dataIndex].recommendedQty;
                                                if (context.datasetIndex === 0) {
                                                    return `Current Purchase Plan: ${current.toLocaleString()} LF`;
                                                } else {
                                                    return `AI Recommendation: ${recommended.toLocaleString()} LF`;
                                                }
                                            },
                                            afterLabel: (context) => {
                                                const dataIndex = context.dataIndex;
                                                const current = purchaseData[dataIndex].currentQty;
                                                const recommended = purchaseData[dataIndex].recommendedQty;
                                                const diff = current - recommended;
                                                if (diff !== 0) {
                                                    return `Difference: ${diff > 0 ? '+' : ''}${diff.toLocaleString()} LF`;
                                                }
                                                return '';
                                            }
                                        }
                                    }
                                }
                            }
                        }),
                        h('div', { className: 'mt-2', style: { display: 'flex', gap: '4px', paddingLeft: '10px', paddingRight: '10px' } },
                            purchaseData.map(item =>
                                h('div', { key: item.week, style: { flex: '1 1 0', minWidth: 0 } },
                                    h('input', {
                                        type: 'number',
                                        value: item.currentQty,
                                        onChange: (e) => handleQuantityChange(item.week, parseInt(e.target.value) || 0),
                                        step: '1000',
                                        className: 'w-full px-1 py-2 border border-border-100 rounded text-center text-xs focus:ring-2 focus:ring-accent-100 focus:border-accent-100'
                                    })
                                )
                            )
                        )
                    ),

                    // Panel 2: Inventory Projection
                    h('div', { className: 'bg-white rounded-lg shadow p-6 mb-6' },
                        h('h2', { className: 'text-xl font-semibold text-text-100 mb-4' }, 'Inventory - On Hand and In Transit'),
                        h(ChartComponent, {
                            type: 'line',
                            data: inventoryChartData,
                            options: {
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: (items) => items[0].label,
                                            label: (context) => {
                                                const dataIndex = context.dataIndex;
                                                const item = mockData.inventoryProjection[dataIndex];
                                                if (context.datasetIndex === 0) {
                                                    return `90th Percentile: ${item.p90.toLocaleString()} LF`;
                                                } else if (context.datasetIndex === 1) {
                                                    return `50th Percentile: ${item.p50.toLocaleString()} LF`;
                                                } else {
                                                    return `10th Percentile: ${item.p10.toLocaleString()} LF`;
                                                }
                                            },
                                            afterBody: (items) => {
                                                const dataIndex = items[0].dataIndex;
                                                const item = mockData.inventoryProjection[dataIndex];
                                                return `\nRange: ${(item.p90 - item.p10).toLocaleString()} LF`;
                                            }
                                        }
                                    }
                                }
                            }
                        })
                    ),

                    // Panel 3: Inventory Arrivals
                    h('div', { className: 'bg-white rounded-lg shadow p-6 mb-6' },
                        h('h2', { className: 'text-xl font-semibold text-text-100 mb-4' }, 'Inventory Arrivals'),
                        h(ChartComponent, {
                            type: 'bar',
                            data: arrivalsChartData,
                            options: {
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: (items) => items[0].label,
                                            label: (context) => {
                                                const dataIndex = context.dataIndex;
                                                const qty = mockData.arrivals[dataIndex].totalQty;
                                                return `Arriving: ${qty.toLocaleString()} LF`;
                                            },
                                            afterLabel: () => {
                                                return 'Click to view PO details';
                                            }
                                        }
                                    }
                                }
                            }
                        })
                    ),

                    // Panel 4: Consumption
                    h('div', { className: 'bg-white rounded-lg shadow p-6 mb-6' },
                        h('div', { className: 'flex justify-between items-center mb-4' },
                            h('h2', { className: 'text-xl font-semibold text-text-100' }, 'Consumption (Forecast Demand)'),
                            h('label', { className: 'flex items-center gap-2' },
                                h('input', {
                                    type: 'checkbox',
                                    checked: showDecomposed,
                                    onChange: (e) => setShowDecomposed(e.target.checked),
                                    className: 'w-4 h-4'
                                }),
                                h('span', { className: 'text-sm font-medium text-text-200' }, 'Decompose into confirmed and expected')
                            )
                        ),
                        h(ChartComponent, {
                            type: 'bar',
                            data: consumptionChartData,
                            options: {
                                ...(showDecomposed ? { scales: { x: { stacked: true }, y: { stacked: true } } } : {}),
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: (items) => items[0].label,
                                            label: (context) => {
                                                const dataIndex = context.dataIndex;
                                                const item = mockData.consumption[dataIndex];
                                                if (showDecomposed) {
                                                    if (context.datasetIndex === 0) {
                                                        return `Confirmed: ${item.confirmed.toLocaleString()} LF`;
                                                    } else {
                                                        return `Expected: ${item.expected.toLocaleString()} LF`;
                                                    }
                                                } else {
                                                    return `Total: ${item.total.toLocaleString()} LF`;
                                                }
                                            },
                                            afterLabel: (context) => {
                                                if (showDecomposed) {
                                                    return 'Click to view order details';
                                                }
                                                return '';
                                            }
                                        }
                                    }
                                }
                            }
                        })
                    ),

                    // Tab Navigation
                    h('div', { className: 'bg-white rounded-lg shadow p-6' },
                        h('div', { className: 'flex gap-4' },
                            h('button', { className: 'px-6 py-2 bg-blue-500 text-white rounded-md font-medium' }, 'Purchase'),
                            h('button', { className: 'px-6 py-2 bg-bg-300 text-text-200 rounded-md font-medium hover:bg-bg-400 transition' }, 'Forecast'),
                            h('button', { className: 'px-6 py-2 bg-bg-300 text-text-200 rounded-md font-medium hover:bg-bg-400 transition' }, 'Demand Orders')
                        )
                    )
                )
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(h(App));
    </script>
</body>
</html>
